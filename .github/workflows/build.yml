name: CI

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  workflow_call:
    secrets:
      MY_APP_ID:
        required: true

jobs:
  
  integration_test_web:
    name: Run Flutter Web Integration Tests
    if: ${{ !contains(github.event.pull_request.labels.*.name, 'ci:skip') }}
    strategy:
      matrix:
        version: ['3.x']
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      TEST_APP_ID: ${{ secrets.MY_APP_ID }}
    steps:
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ matrix.version }}
          cache: true
      - name: Run web integration test
        shell: bash
        run: |
          chromedriver --port=4444 --trace-buffer-size=100000 &
          bash ci/run_flutter_integration_test.sh web

  build_web:
    name: Build Web
    if: ${{ !contains(github.event.pull_request.labels.*.name, 'ci:skip') }}
    strategy:
      matrix:
        version: ["2.10.5", "3.x"]
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ matrix.version }}
          cache: true
      - run: flutter packages get
      - name: Run flutter build web
        run: flutter build web
        working-directory: example

  rendering_test_web:
    name: Run Flutter Web Rendering Tests
    if: ${{ !contains(github.event.pull_request.labels.*.name, 'ci:skip') }}
    strategy:
      matrix:
        version: ['3.x']
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      TEST_APP_ID: ${{ secrets.MY_APP_ID }}
    steps:
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ matrix.version }}
          cache: true
      - name: Run web rendering test
        shell: bash
        run: |
          export SAVE_DEBUG_GOLDEN="true"

          chromedriver --port=4444 --trace-buffer-size=100000 &
          bash ci/run_rendering_test.sh web

      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: web-debug-golden-files
          path: test_shard/rendering_test/screenshot/*.debug.png
